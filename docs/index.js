import signaturePad from"https://cdn.jsdelivr.net/npm/signature_pad@5.1.2/+esm";import{createWorker}from"https://cdn.jsdelivr.net/npm/emoji-particle@0.0.4/+esm";const countPanel=document.getElementById("countPanel"),infoPanel=document.getElementById("infoPanel"),playPanel=document.getElementById("playPanel"),scorePanel=document.getElementById("scorePanel"),canvasContainer=document.getElementById("canvasContainer"),canvases=[...canvasContainer.getElementsByTagName("canvas")],canvasCache=document.createElement("canvas").getContext("2d",{willReadFrequently:!0}),pads=initSignaturePads(canvases),gameTime=180,emojiParticle=initEmojiParticle(),maxParticleCount=10;let gameTimer,answers=new Array(3),hinted=!1,consecutiveWins=0,correctCount=0,audioContext;const audioBufferCache={};loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function createAudioContext(){return globalThis.AudioContext?new globalThis.AudioContext:(console.error("Web Audio API is not supported in this browser"),null)}function unlockAudio(){audioContext?audioContext.resume():(audioContext=createAudioContext(),loadAudio("end","mp3/end.mp3"),loadAudio("correct","mp3/correct3.mp3"),loadAudio("incorrect","mp3/incorrect1.mp3")),document.removeEventListener("pointerdown",unlockAudio),document.removeEventListener("keydown",unlockAudio)}async function loadAudio(e,t){if(!audioContext)return;if(audioBufferCache[e])return audioBufferCache[e];try{const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}catch(t){throw console.error(`Loading audio ${e} error:`,t),t}}function playAudio(e,t){if(!audioContext)return;const o=audioBufferCache[e];if(!o){console.error(`Audio ${e} is not found in cache`);return}const n=audioContext.createBufferSource();n.buffer=o;const s=audioContext.createGain();t&&(s.gain.value=t),s.connect(audioContext.destination),n.connect(s),n.start()}function initEmojiParticle(){const e=document.createElement("canvas");Object.assign(e.style,{position:"fixed",pointerEvents:"none",top:"0px",left:"0px"}),e.width=document.documentElement.clientWidth,e.height=document.documentElement.clientHeight,document.body.prepend(e);const t=e.transferControlToOffscreen(),n=createWorker();return n.postMessage({type:"init",canvas:t},[t]),globalThis.addEventListener("resize",()=>{const e=document.documentElement.clientWidth,t=document.documentElement.clientHeight;n.postMessage({type:"resize",width:e,height:t})}),{canvas:e,offscreen:t,worker:n}}function isEqual(e,t){for(let n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function getNumRange(e){switch(e){case 1:return[8,2,8,2,0,0,0,0];case 2:return[28,6,28,6,8,2,0,0];case 3:return[38,11,38,11,8,2,8,2];case 4:return[38,11,38,11,12,2,16,4];case 5:return[99,50,99,50,16,4,20,6];case 6:return[99,50,99,50,14,6,20,8];default:return[388,111,388,111,12,8,20,11]}}function generateData(){const a=document.getElementById("gradeOption").selectedIndex+1,r=document.getElementById("courseOption").selectedIndex-1,e=getNumRange(a);let n,t,s,o,i;switch(r<0?a==1?i=Math.floor(Math.random()*2):a==2?i=Math.floor(Math.random()*3):i=Math.floor(Math.random()*4):i=r,i){case 0:n=Math.floor(Math.random()*e[0]+e[1]),t=Math.floor(Math.random()*e[0]+e[1]),s=n+t,o="＋";break;case 1:t=Math.floor(Math.random()*e[2]+e[3]),s=Math.floor(Math.random()*e[2]+e[3]),n=t+s,o="−";break;case 2:n=Math.floor(Math.random()*e[4]+e[5]),t=Math.floor(Math.random()*e[4]+e[5]),s=n*t,o="×";break;case 3:t=Math.floor(Math.random()*e[6]+e[7]),s=Math.floor(Math.random()*e[6]+e[7]),n=t*s,o="÷";break;default:console.log("error")}const c=document.getElementById("num");c.textContent=`${n}${o}${t}＝`;const l=("   "+s).slice(-3);answers=l.split("");for(let e=0;e<canvases.length;e++)canvases[e].dataset.predict=" ",pads[e].clear()}function countdown(){countPanel.classList.remove("d-none"),infoPanel.classList.add("d-none"),playPanel.classList.add("d-none"),scorePanel.classList.add("d-none");const e=document.getElementById("counter");e.textContent=3;const t=setInterval(()=>{const n=["skyblue","greenyellow","violet","tomato"];if(parseInt(e.textContent)>1){const t=parseInt(e.textContent)-1;e.style.backgroundColor=n[t],e.textContent=t}else clearInterval(t),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),playPanel.classList.remove("d-none"),correctCount=0,consecutiveWins=0,hinted=!1,generateData(),startGameTimer()},1e3)}function startGame(){clearInterval(gameTimer),initTime(),countdown()}function startGameTimer(){const e=document.getElementById("time");initTime(),gameTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(gameTimer),playAudio("end"),playPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),scoring())},1e3)}function initTime(){document.getElementById("time").textContent=gameTime}function scoring(){document.getElementById("score").textContent=correctCount}function eraserEvent(e){e.clear(),e.canvas.dataset.predict=" "}function initSignaturePads(e){const t=[];for(let s=0;s<e.length;s++){const o=e[s],n=new signaturePad(o,{minWidth:5,maxWidth:5,penColor:"black",backgroundColor:"white",throttle:0});n.addEventListener("endStroke",()=>{const s=n.toData();let t=0;for(let e=0;e<s.length;e++)t+=s[e].points.length;if(5<t&&t<100){const o=e.indexOf(n.canvas);predict(n.canvas,o,s.length,t)}});const i=o.nextElementSibling;navigator.maxTouchPoints>0?i.ontouchstart=()=>eraserEvent(n):i.onclick=()=>eraserEvent(n),t.push(n)}return t}function getImageData(e){const n=28,s=28;canvasCache.drawImage(e,0,0,n,s);const o=canvasCache.getImageData(0,0,n,s),t=o.data;for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2];return o}const kakusus=[1,1,1,1,2,2,1,2,1,1];function getReplies(e){const n=canvases[e.pos],t=new Array(3).fill(" ");for(let e=0;e<canvases.length;e++)t[e]=canvases[e].dataset.predict;return e.klass!=1&&e.count<15?e.klass=" ":e.kaku<kakusus[e.klass]&&(e.klass=" "),n.dataset.predict=e.klass,t[parseInt(n.getAttribute("id").slice(-1))]=e.klass.toString(),t}function predict(e,t,n,s){const o=getImageData(e);worker.postMessage({pos:t,imageData:o,kaku:n,count:s})}function showAnswer(){hinted||(hinted=!0,consecutiveWins=0,document.getElementById("num").textContent+=answers.join("").trimStart(),playAudio("incorrect",.3),setTimeout(()=>{hinted=!1,generateData()},3e3))}const worker=new Worker("worker.js");if(worker.addEventListener("message",e=>{const t=getReplies(e.data);if(isEqual(answers,t)){if(playAudio("correct",.3),hinted||(correctCount+=1,consecutiveWins+=1),consecutiveWins%5===0){const e=Math.ceil(consecutiveWins/5);for(let t=0;t<Math.min(e,maxParticleCount);t++)emojiParticle.worker.postMessage({type:"spawn",options:{particleType:"popcorn",originX:Math.random()*emojiParticle.canvas.width,originY:Math.random()*emojiParticle.canvas.height}})}hinted=!1,generateData()}}),generateData(),document.getElementById("hint").onclick=showAnswer,document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=startGame,document.getElementById("restartButton").onclick=startGame,document.addEventListener("pointerdown",()=>{predict(pads[0].canvas,0,0,0)},{once:!0}),document.addEventListener("pointerdown",unlockAudio,{once:!0}),document.addEventListener("keydown",unlockAudio,{once:!0}),CSS.supports("-webkit-touch-callout: default")){document.addEventListener("dblclick",e=>e.preventDefault());const e=e=>e.preventDefault(),t=document.getElementById("canvasContainer");t.addEventListener("touchstart",()=>{document.addEventListener("touchstart",e,{passive:!1})}),t.addEventListener("touchend",()=>{document.removeEventListener("touchstart",e,{passive:!1})})}